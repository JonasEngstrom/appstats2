---
title: "exercise_two"
author: "Jonas Engström"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{exercise_two}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Exercise Linear Regression with One Explanatory Variable

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8.9,
  fig.height = 5,
  out.width = "100%"
)
```

```{r setup, message=FALSE}
library(appstats2)
library(tidyverse)
library(kableExtra)
```

The instructions below are copied from [the Lund University website](https://canvas.education.lu.se/courses/34580/files/6061965?module_item_id=1441722).

### Introduction

This lab illustrates the use and interpretation of simple linear regression. The lab uses the same dataset “bloodpressure” that you used in Lab 1, i.e. a subset of the Framingham Heart Study: [https://www.framinghamheartstudy.org/about-fhs/history.php](https://www.framinghamheartstudy.org/about-fhs/history.php). We are interested in investigating the relationship between systolic blood pressure (SBP), sex, smoking and BMI.

On the course webpage you find program-specific hints (SPSS, R and STATA) to the lab tasks.

Be careful to save all useful commands in a *well-commented syntax file* (meaning syntax-file in SPSS, do-file in Stata, R-script in R) including all steps from reading the data, to descriptive statistics and the formal analyses. (However, do not save your bad tries other than as comments.)

### Reading the data

1. ***Use the program-specific hints*** for opening your software, creating a ***new syntax file*** and reading the blood-pressure data. The next step is to get acquainted to the data by browsing, plotting, summarizing or tabulating some of the variables.

> The data is loaded in this document using the command `library(appstats2)` in the code chunk above. For the sourcecode importing the data from the provided Excel file and formatting it as a tibble, please see the file [`bloodpressure.R`](https://github.com/JonasEngstrom/appstats2/blob/main/data-raw/bloodpressure.R).

### Plot the data

2. Our first focus will be on Systolic blood pressure (SBP), so start by plotting SBP vs sex, SBP vs BMI and SBP vs smoking. Inspect each of the graphs and describe

    ```{r plot-sbp-bmi}
    bloodpressure |>
      ggplot(aes(x=SBP, y=BMI)) +
      geom_point() +
      labs(
        title = 'Systolic blood pressure vs body mass index',
        x = 'Systolic Blood Pressure (mmHg)',
        y = 'Body Mass Index (kg/m^2)'
      )
    ```

    ```{r plot-sbp-sex}
    bloodpressure |>
      mutate(sex = as.factor(sex)) |>
      ggplot(aes(x=SBP, y=sex, color=sex)) +
      geom_boxplot(color = 'black') +
      geom_jitter(height = .25, alpha = .5) +
      labs(
        title = 'Systolic blood pressure vs sex',
        x = 'Systolic Blood Pressure (mmHg)',
        y = 'Sex'
      ) +
      theme(
        legend.position = 'none'
      )
    ```

    ```{r plot-sbp-smoking}
    bloodpressure |>
      mutate(smoker = as.factor(smoker)) |>
      ggplot(aes(x=SBP, y=smoker, color=smoker)) +
      geom_boxplot(color = 'black') +
      geom_jitter(height = .25, alpha = .5) +
      labs(
        title = 'Systolic blood pressure vs smoking',
        x = 'Systolic Blood Pressure (mmHg)',
        y = 'Smoker'
      ) +
      theme(
        legend.position = 'none'
      )
    ```
    
    - how SBP varies with sex, smoking and BMI respectively?
    
    > SBP seems to be higher with higher BMI and possibly with smoking. With sex number 2 there seems to be a larger range of SBP values.
    
    - if there are potential outliers in the data?
    
    > Yes, there are.

3. Calculate and compare the Pearson and Spearman correlation of SBP and BMI.

    ```{r pearson}
    cor(bloodpressure |> pull(SBP), bloodpressure |> pull(BMI), method = 'pearson')
    ```

    ```{r spearman}
    cor(bloodpressure |> pull(SBP), bloodpressure |> pull(BMI), method = 'spearman')
    ```

> The Spearman coefficient is slightly higher than the Pearson coefficient.

### Linear regression

The first interest of the researchers is the relation between BMI and SBP.

4. Then fit a linear regression model with SBP as response and BMI as explanatory variable.

    ```{r sbp-bmi-linear-model}
    sbp_bmi_linear_model <-
      lm(SBP ~ BMI, bloodpressure)
    ```

  - Write down the linear equation and interpret the model.
    
  > $y(x)=`r sbp_bmi_linear_model$coefficients['BMI']`x+`r sbp_bmi_linear_model$coefficients['(Intercept)']`$
    
  - Illustrate the data in a scatterplot of SBP vs BMI with the fitted regression line superposed. Does SBP have a linear dependency with BMI? How much of SBP-variation can be explained by BMI?

    ```{r plot-sbp-bmi-linear-model}
    bloodpressure |>
      ggplot(aes(x=SBP, y=BMI)) +
      geom_point() +
      labs(
        title = 'Systolic blood pressure vs body mass index',
        x = 'Systolic Blood Pressure (mmHg)',
        y = 'Body Mass Index (kg/m^2)'
      ) +
      geom_smooth(
        method = 'lm',
        se = FALSE
      )
    ```

  - How would you present the results from the regression analysis?
  
  > There seems to be a correleation between body mass index and systolic blood pressure.

Testing model assumptions for the linear regression model:

5. The linear regression model is based on certain assumptions, and only if they are fulfilled should you trust the results of the model.
    - Assess if residuals are normal and have constant variance in the model you just fitted.  
    
    ```{r sbp-bmi-linear-model-residuals}
    summary(sbp_bmi_linear_model)
    ```

    ```{r sbp-bmi-linear-model-residuals-plot}
    plot(sbp_bmi_linear_model)
    ```

    (\* If time permits you will later return to the data and perform transformations to see if that can make the data suit even better with the linear regression model).

### Linear regression with a factor on two levels and other two-group comparisons:

Although not of primary interest in the original study, we will for pedagogic reasons study if there is a non-random difference between the systolic blood pressure of smokers and non-smokers.

6. Before discussing test-strategies, have a brief look at the data.
    - Make a table with relevant summary statistics (e.g. mean, sd, median, quartiles, min, max) for SBP for smokers and non-smokers separately
    
    ```{r sbp-smoking-summary-table}
    bloodpressure |>
      group_by(smoker) |>
      summarize(
        sbp_min = min(SBP),
        sbp_mean = mean(SBP),
        sbp_median = median(SBP),
        sbp_max = max(SBP),
        sbp_sd = sd(SBP)
      ) |>
      kbl()
    ```

7. Reflect on test strategies. Use your knowledge from previous courses and name at least 2 different ways to test if there is a non-random difference between the systolic blood pressure of smokers and non-smokers.
    - Perform these analyses and interpret the results

8. Now use linear regression with smoking as explanatory variable:
    - What is the estimated effect of smoking on SBP?
    - What is the interpretation of the other estimated model parameters?

9. Compare the results of the tests from point 7 and 8.
    - Do you get the same conclusion from all tests?
    - Reflect on the model assumptions for the different tests and if they are fulfilled?
    - Which result would you prefer to present?

### Logistic regressioin with a binary exposure

1. Start by investigating if hypertension is equally common among males and females in the population from which this sample was drawn. To do this:
    - Make a crosstable for ht vs sex, with the most relevant percentages included.
    - Calculate by hand the relative risk of ht for men compared to women.
    - Calculate by hand the corresponding odds ratio (OR)

2. Now, fit a logistic regression model to investigate the effect of (male) sex on outcome ht.
    - Compare with the results you calculated by hand.
    - Is there evidence of an effect of sex on ht?

### Logistic regression with a linear exposure

3. The next step is to investigate if BMI is related to ht. Start by looking at data; simplest (but slightly backward) in a boxplot of BMI separated for ht-status.

4. Now fit a logistic regression model for the effect of BMI (as a linear covariate) on ht.
    - Was there evidence of an effect?
    - How do you interpret the resulting odds ratio?
    - Report the relevant results (including effects measures with CI).

5. Create a new variable, BMI_4, that categorizes BMI into the following four categories (see Hints):

```{r bmi-table, echo=FALSE}
tibble(
  BMI = c(
    '<18.5',
    '≥18.5 but <25',
    '≥25 but <30',
    '≥30'
  ),
  code = c(
    1,
    2,
    3,
    4
  ),
  label = c(
    'Underweight',
    'Normal',
    'Overweight',
    'Extreme overweight'
  )
) |>
  kbl()
```

6. Fit a logistic regression model with ht as dependent variable and the new ordered categorical BMI-variable (BMI_4) as a factor on 4 levels (3 degrees of freedom; 3 OR:s will be estimated relative to a reference category).
    - Reflect on the choice of reference category and interpret the estimated odds ratios.

7. It is suboptimal to use a very small category as reference category. An alternative is to use e.g. normal weight as reference category. This is straightforward in R and STATA, and also in SPSS - if you use syntax. (See Hints!)
    - Perform a logistic regression analysis with ht as dependent variable and the new ordered categorical BMI-variable (BMI_4) as a factor on 4 levels with normal weight as the reference category (3 degrees of freedom; 3 OR:s will be estimated relative to the reference category).
    - Interpret the result and compare effect sizes, confidence intervals and p-values to the previous results.

## Extra exercises—linear regression

1. As you discussed during Day 1, one should always be aware of the possibility that differences in an observational study could be affected by confounding. To better understand the data, and as a first step to investigate possible confounding, present descriptive statistics for the background variables (eg. BMI and age), separated for smoking.

Comment on the differences/similarities between smokers and non-smokers for these
variables.

Note that confounding is often investigated and handled using regression methods, as you will
learn later on in the course.

### If time permits: Transformation

Go back to the investigation of BMI on SBP

2. In the model validation after the linear regression assessing the effect of BMI on SBP you probably found that residuals were skewed to the right, i.e. have too many large values compared to the normal distribution. A possible remedy is to investigate SBP on a log-scale. To do this create a new variable (logSBP) by logging SBP.

3. Perform a linear regression with logSBP as dependent and BMI as independent.

4. Write down the model equation and interpret the estimated parameters.

5. Plot logSBP vs BMI and add the fitted regression line. Also perform a graphical model validation, to see if the assumptions of the linear regression model are fulfilled.

6. Which results would you report if you were publishing results on the effect of BMI on SBP?

7. **At the end of the lab:**

8. Save the syntax-file so that you will not lose your work.

9. The lab in simple logistic regression will utilize the same dataset
