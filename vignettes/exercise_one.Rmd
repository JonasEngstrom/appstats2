---
title: "exercise_one"
author: "Jonas Engström"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{exercise_one}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Exercise 1: Analyses of 2-by-2 tables

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(appstats2)
library(tidyverse)
library(kableExtra)
```

The instructions below are copied from [the Lund University website](https://canvas.education.lu.se/courses/34580/files/6116314?module_item_id=1441704).

We strongly recommend using *syntax* when solving the exercises in this course and that you intersperse the syntax files with informative comments. By doing this, you can get back to your analysis at a later point to check what you have done and to make relevant changes. You do not need to hand in any syntax files from the computer exercises during the first course week; however, this will be required for the project and the exam.

Note that there are program-specific **hints** for the computer exercises, which you are welcome to look at. The hints for this lab also introduce script-based data analysis.

## Analysis of 2-by-2 tables

### A cohort study

The Framingham Heart Study (Levy, 1999) has collected long-term follow-up and cardiovascular risk factor data on almost 5000 residents of the town of Framingham, Massachusetts. Recruitment of subjects started in 1948. At the time of the baseline exams there were no effective treatments for hypertension. The subjects were free of coronary heart disease at the baseline exam.

We will use variables registered and measured at this exam, some **derived variables** and also simulated data (for teaching purposes). The variables we have selected for this exercise are: sex, age, Body Mass Index (BMI), Serum Cholesterol (SCL), systolic blood pressure (SBP), diastolic blood pressure (DBP), and smoker. The variable hypertension (ht) has been derived from the two blood pressure variables:

ht = 1 (TRUE) if SBP ≥ 140 or DBP ≥ 90, 0 (FALSE) otherwise

Finally, two variables from the 40-year follow-up have been added to the dataset: fu_years, the individual’s follow-up time in years, and a **binary outcome variable** chd_event (1 for CHD event at last follow-up; 0 otherwise).

The dataset *bloodpressure*, which you find on the course web site, is a subset of the 40-year data.

Read the data into your statistics package (see the program-specific hints).

> The data is loaded in this document using the command `library(appstats2)` in the code chunk above. For the sourcecode importing the data from the provided Excel file and formatting it as a tibble, please see the file [`bloodpressure.R`](https://github.com/JonasEngstrom/appstats2/blob/main/data-raw/bloodpressure.R).

1. As a first task, we investigate the association between smoking and hypertension.

    a) Tabulate the data (2x2 table; smoker in rows and ht in columns). Do you prefer row- or column percentages? Why?
    
    ```{r data-tabulation, message=FALSE}
    bloodpressure |>
      
      # Recode hypertension and smoker variables for better readability.
      mutate(
        across(
          smoker,
          ~ case_match(
            .,
            TRUE ~ 'Smoker',
            FALSE ~ 'Non-smoker'
          )
        ),
        across(
          ht,
          ~ case_match(
            .,
            TRUE ~ 'Hypertension',
            FALSE ~ 'No hypertension'
          )
        )
      ) |>
      
      # Make crosstable.
      group_by(smoker, ht) |>
      summarize(n = n()) |>
      spread(smoker, n) |>
      ungroup() |>
      relocate('Non-smoker', .after = Smoker) |>
      
      # Format crosstable for nicer output.
      rename(' ' = ht) |>
      kbl() |>
      kable_classic()
    ```
    
    > Both row and column percentages could be informative, depending on whether one is interested in what proportion of smokers have hypertension or what proportion of people with hypertension smoke.

    b) Conduct a statistical test of whether hypertension is equally common in smokers and non-smokers.
    
    ```{r smoking-test}
    chisq.test(bloodpressure |> pull(smoker), bloodpressure |> pull(ht))
    ```
    
    c) Summarize the relationship between smoking and hypertension by one or several **measures of association**. First, calculate your measure(s) based on the 2x2 table by hand or your cell phone calculator. Then try to find a built-in command in your software and check if it gives you the same result.
    
    ```{r manual-measure-of-association}
    # Manual calculation. Relative risk of hypertension for smokers vs non-smokers.
    (136 / (136 + 132)) / (45 / (45 + 126))
    ```
    
    ```{r built-in-measure-of-association, message=FALSE}
    # Calculation using software. Relative risk of hypertension for smokers vs non-smokers.
    bloodpressure |>
      group_by(smoker, ht) |>
      summarize(n = n()) |>
      mutate(sum = sum(n), percentage = n / sum) |>
      filter(ht) |>
      select(smoker, percentage) |>
      pivot_wider(names_from = smoker, values_from = percentage) |>
      mutate(relative_risk = `TRUE` / `FALSE`) |>
      pull(relative_risk)
    ```

### Incidence rates

2. Investigate if hypertension (ht) is a risk factor for cardiovascular disease by calculating and comparing the incidence rates of CHD in the two ht-groups. Hint: A crosstab of ht vs chd_event contains the numerators, i.e., the number of (first) disease events per ht-group. The denominators would be the total number of person-years in each ht-group.

    ```{r chd-incidence}
    bloodpressure |>
      
      # Recode hypertension variable for better readability.
      mutate(
        across(
          ht,
          ~ case_match(
            .,
            TRUE ~ 'Hypertension',
            FALSE ~ 'No hypertension'
          )
        )
      ) |>
      
      # Calculate incidence rates for CHD events per hypertension group.
      group_by(ht) |>
      summarize(
        total_chd_events = sum(chd_event),
        total_fu_years = sum(fu_years)
      ) |>
      mutate(incidence_per_1000_years = total_chd_events / total_fu_years * 1000) |>
      
      # Format table for nicer output.
      select(' ' = ht, 'Incidence of CHD events per 1,000 follow-up years' = incidence_per_1000_years) |>
      kbl() |>
      kable_classic()
    ```

We will return to the blood pressure dataset many times during this course, but not during this exercise, so save the syntax/script and close the dataset. If you have followed the instructions above, you do not have to save the dataset; it has not been modified.

### A case-control study

Feldkamp and co-authors investigated the association between genitourinary infections in the month before conception to the end of the first trimester, and gastroschisis. The study was published in BMJ 2008: 336(7658):1420-3. The data can be summarized in a table like below:

```{r feldkamp-table, echo=FALSE}
tibble(
  `Mother exposed to infection?` = c('No', 'Yes'),
  Control = c(4499, 425),
  Case = c(424, 81)
) |>
  kbl()
```

Read the dataset **Feldkamp** from file. We suggest that you use separate syntax-files for separate projects. Like the previous one, this syntax file should start by reading the dataset into your statistics package and proceed with the relevant analyses interspersed with comments. Note that once you have connected the datafile to the analyses performed in the script you do not have to save any results (OUTPUT in SPSS). The same output will always be produced when the syntax is executed (**reproducible statistical analyses!**). Keep only the relevant commands in the final syntax file, i.e. delete all the code sections corresponding to attempts that did not produce the intended output.

> The data is loaded in this document using the command `library(appstats2)` in the code chunk above. For the sourcecode importing the data from the provided Excel file and formatting it as a tibble, please see the file [`bloodpressure.R`](https://github.com/JonasEngstrom/appstats2/blob/main/data-raw/bloodpressure.R).

3. Analyze the data. Are row or column percentages, or both, relevant? Calculate an appropriate effect measure.

> Both would be relevant if we want to know the exposure to infection as well as the incidence of gastroschisis.

```{r odds-ratio-function-definition}
#' Odds Ratio
#' 
#' Calculated the odds ratio given information on cases, controls, and exposure.
#'
#' @param exposed_cases The number of cases that were exposed.
#' @param unexposed_cases The number of cases that were not exposed.
#' @param exposed_controls The number of controls that were exposed.
#' @param unexposed_controls The number of controls that where not exposed.
#'
#' @returns Th odds ratio.
#' @export
#'
#' @examples
#' odds_ratio(5, 2, 2, 5)
odds_ratio <- function(exposed_cases, unexposed_cases, exposed_controls, unexposed_controls) {
  (exposed_cases / unexposed_cases) / (exposed_controls / unexposed_controls)
}
```
    
```{r feldkamp-exposure-and-cases, message=FALSE}
feldkamp |>
  mutate(
    across(
      case,
      ~ case_match(
        .,
        TRUE ~ 'case',
        FALSE ~ 'control'
      )
    ),
    across(
      m_inf,
      ~ case_match(
        .,
        TRUE ~ 'exposed',
        FALSE ~ 'unexposed'
      )
    )
  ) |>
  group_by(case, m_inf) |>
  summarize(n = n()) |>
  pivot_wider(names_from = c(case, m_inf), values_from = n) |>
  (\(x) odds_ratio(
    exposed_cases = x |> pull(case_exposed),
    unexposed_cases = x |> pull(case_unexposed),
    exposed_controls = x |> pull(control_exposed),
    unexposed_controls = x |> pull(control_unexposed)
  ))()
```

4. Confounding (lack of comparability between cases and controls) is always an issue in observational studies. What type of information could be relevant to include in the analysis (if collected)?

5. Why do you think they designed the study as a case-control study and not a cohort study?

6. What is the prevalence of the disease (Google search)?

The paper by Feldkamp et al. can be found on the course web site. Browse through/read it.
